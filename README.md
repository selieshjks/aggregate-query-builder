
# Aggregate Query Builder

A simple and flexible query builder for MongoDB aggregation using Mongoose. This package provides a fluent interface to build complex aggregation pipelines with support for main and sub-pipelines. It supports various MongoDB stages like `$match`, `$lookup`, `$unwind`, `$group`, and more, with easy-to-use methods for chaining queries.

## Installation

To install the package, run the following command:

```bash
npm install aggregate-query-builder
```

## Usage

### 1. Import and Instantiate the Builder

First, require the package and create an instance by passing your Mongoose model to it.

```javascript
const AggregateQueryBuilder = require('aggregate-query-builder');
const MyModel = require('./models/myModel');

// Create an instance of the query builder
const queryBuilder = new AggregateQueryBuilder(MyModel);
```

### 2. Add Stages to the Pipeline

The builder provides various methods to add different aggregation stages. You can add stages to either the main pipeline or sub-pipelines.

#### Match Stages

- **Match by equality**:
  ```javascript
  queryBuilder.matchEqual('status', 'active');
  ```

- **Match with a range condition**:
  ```javascript
  queryBuilder.matchRange('age', '$gte', 18);
  ```

- **Match less than**:
  ```javascript
  queryBuilder.matchLessThan('age', 30);
  ```

- **Match greater than**:
  ```javascript
  queryBuilder.matchGreaterThan('age', 50);
  ```

- **Conditional match (`$cond`)**:
  ```javascript
  queryBuilder.matchIf(
    { $gt: ['$age', 18] },  // Condition
    { status: 'adult' },    // If true
    { status: 'minor' }     // If false
  );
  ```

- **Switch condition (`$switch`)**:
  ```javascript
  queryBuilder.matchSwitch(
    'age',
    [
      { caseCondition: { $lt: [ '$age', 18 ] }, then: 'minor' },
      { caseCondition: { $gte: [ '$age', 18 ] }, then: 'adult' }
    ]
  );
  ```

#### Sub-pipeline Support

Add stages to sub-pipelines by setting `isSubPipeline = true`. You can provide a custom name or let it be autogenerated.

```javascript
// Add match to the sub-pipeline with default name
queryBuilder.matchEqual('age', 30, true);

// Add match to the sub-pipeline with custom name
queryBuilder.matchEqual('age', 40, true, 'customSubPipeline');
```

#### Sub-pipeline Handling

- **Append sub-pipeline to the main pipeline**:
  ```javascript
  queryBuilder.appendSubPipeline();
  ```

- **Retrieve and remove a sub-pipeline by key**:
  ```javascript
  const subPipeline = queryBuilder.getSubPipelineByKey('customSubPipeline');
  ```

#### Other Stages

- **Lookup**: Perform `$lookup` to join other collections.
  ```javascript
  queryBuilder.lookup(['user'], true); // Automatically fetch reference
  ```

- **Unwind**: Flatten arrays from `$lookup` results.
  ```javascript
  queryBuilder.unwind(['user'], true);
  ```

- **Group**: Group documents and perform aggregation.
  ```javascript
  queryBuilder.group({ _id: '$status', total: { $sum: 1 } });
  ```

- **Project**: Specify fields to include/exclude.
  ```javascript
  queryBuilder.project({ name: 1, age: 1 });
  ```

- **Sort**: Sort documents.
  ```javascript
  queryBuilder.sort({ age: 1 });
  ```

- **Skip**: For pagination.
  ```javascript
  queryBuilder.skip(10);
  ```

- **Limit**: For pagination.
  ```javascript
  queryBuilder.limit(20);
  ```

- **Facet**: Run multiple aggregations in parallel.
  ```javascript
  queryBuilder.facet({ status: [{ $match: { status: 'active' } }] });
  ```

### 3. Build the Final Pipeline

Once all stages are added, build the final aggregation pipeline:

```javascript
const pipeline = queryBuilder.build();
```

You can then pass this pipeline to Mongoose's `aggregate()` method.

### Example

```javascript
const queryBuilder = new AggregateQueryBuilder(MyModel);

// Build aggregation pipeline
queryBuilder
  .matchEqual('status', 'active')
  .matchGreaterThan('age', 18)
  .lookup(['user'], true)
  .unwind(['user'], true)
  .group({ _id: '$status', total: { $sum: 1 } })
  .appendSubPipeline();

// Final pipeline
const pipeline = queryBuilder.build();

// Use the pipeline with Mongoose
MyModel.aggregate(pipeline)
  .then(results => console.log(results))
  .catch(err => console.error(err));
```

### Methods Overview

- **`matchEqual(field, value, isSubPipeline, name)`**: Adds a `$match` stage with equality condition.
- **`matchRange(field, operator, value, isSubPipeline, name)`**: Adds a `$match` stage with a range condition.
- **`matchLessThan(field, value, isSubPipeline, name)`**: Adds a `$match` stage with a less than condition.
- **`matchGreaterThan(field, value, isSubPipeline, name)`**: Adds a `$match` stage with a greater than condition.
- **`matchIf(condition, trueMatch, falseMatch, isSubPipeline, name)`**: Adds a conditional `$match` stage.
- **`matchSwitch(switchField, cases, isSubPipeline, name)`**: Adds a `$match` stage with a switch condition.
- **`lookup(fields, isSubPipeline, name)`**: Adds a `$lookup` stage to join other collections.
- **`unwind(fields, isSubPipeline, name)`**: Adds a `$unwind` stage to flatten arrays.
- **`group(groupConditions, isSubPipeline, name)`**: Adds a `$group` stage to group documents.
- **`project(fields, isSubPipeline, name)`**: Adds a `$project` stage to include/exclude fields.
- **`sort(sortConditions, isSubPipeline, name)`**: Adds a `$sort` stage.
- **`skip(skipValue, isSubPipeline, name)`**: Adds a `$skip` stage for pagination.
- **`limit(limitValue, isSubPipeline, name)`**: Adds a `$limit` stage for pagination.
- **`facet(facets, isSubPipeline, name)`**: Adds a `$facet` stage to run multiple aggregations.
- **`appendSubPipeline()`**: Appends all sub-pipelines to the main pipeline.
- **`getSubPipelineByKey(key)`**: Retrieves and removes a sub-pipeline by its key.

## License

This project is licensed under the MIT License - see the [LICENSE](LICENSE) file for details.
